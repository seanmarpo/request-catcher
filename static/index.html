<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Web Request Catcher</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Inter", sans-serif;
            }
        </style>
        <script>
            // Apply dark mode based on system preference
            if (
                window.matchMedia &&
                window.matchMedia("(prefers-color-scheme: dark)").matches
            ) {
                document.documentElement.classList.add("dark");
            }
        </script>
    </head>
    <body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100">
        <div class="container mx-auto p-4 max-w-xl">
            <h1 class="text-3xl font-bold mb-4 text-center">
                Web Request Catcher
            </h1>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-6">
                Create a new bucket or select an existing one below.
            </p>

            <!-- Error Message Area -->
            <div
                id="errorMessage"
                class="hidden bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg mb-6"
                role="alert"
            >
                <strong class="font-bold">Error: </strong>
                <span id="errorText"></span>
            </div>

            <!-- Create Bucket Section -->
            <div
                class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-6"
            >
                <h2 class="text-xl font-semibold mb-4">Create a New Bucket</h2>
                <div class="space-y-4">
                    <input
                        type="text"
                        id="bucketName"
                        placeholder="Enter new bucket name"
                        class="w-full p-2 border dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-400"
                    />
                    <input
                        type="password"
                        id="bucketPassword"
                        placeholder="Enter a password for the new bucket"
                        class="w-full p-2 border dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-400"
                    />
                    <button
                        id="createBucketBtn"
                        class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                    >
                        Create and View Bucket
                    </button>
                </div>
            </div>

            <!-- Existing Buckets Section -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Existing Buckets</h2>
                <div id="bucketsList" class="space-y-2">
                    <p class="text-gray-500 dark:text-gray-400">
                        Loading buckets...
                    </p>
                </div>
            </div>
        </div>

        <script>
            (() => {
                "use strict";

                // DOM element cache
                const elements = {
                    createBucketBtn: null,
                    bucketNameInput: null,
                    bucketPasswordInput: null,
                    bucketsList: null,
                    errorMessage: null,
                    errorText: null,
                };

                // Utility: Show error message
                function showError(message) {
                    elements.errorText.textContent = message;
                    elements.errorMessage.classList.remove("hidden");
                    setTimeout(() => {
                        elements.errorMessage.classList.add("hidden");
                    }, 5000);
                }

                // Utility: Navigate to bucket page
                function navigateToBucket(bucketName, password) {
                    const url = `/ui/bucket.html?name=${encodeURIComponent(bucketName)}&password=${encodeURIComponent(password)}`;
                    window.location.href = url;
                }

                // Utility: Create element helper
                function createElement(tag, className, textContent = null) {
                    const el = document.createElement(tag);
                    if (className) el.className = className;
                    if (textContent) el.textContent = textContent;
                    return el;
                }

                // Create a new bucket
                async function createBucket() {
                    const bucketName = elements.bucketNameInput.value.trim();
                    const password = elements.bucketPasswordInput.value.trim();

                    if (!bucketName || !password) {
                        showError(
                            "Please enter both a bucket name and a password.",
                        );
                        return;
                    }

                    try {
                        const response = await fetch(
                            `/api/create/${bucketName}`,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ password }),
                            },
                        );

                        if (response.ok) {
                            navigateToBucket(bucketName, password);
                        } else {
                            const errorText = await response.text();
                            showError(`Failed to create bucket: ${errorText}`);
                        }
                    } catch (error) {
                        console.error("Error creating bucket:", error);
                        showError(
                            "An error occurred while creating the bucket.",
                        );
                    }
                }

                // Handle enter key press
                function handleEnterKey(event) {
                    if (event.key === "Enter") {
                        createBucket();
                    }
                }

                // Handle bucket link click
                function handleBucketClick(bucketName) {
                    return (event) => {
                        event.preventDefault();
                        const password = prompt(
                            `Enter password for bucket "${bucketName}":`,
                        );

                        if (password !== null && password.trim() !== "") {
                            navigateToBucket(bucketName, password);
                        }
                    };
                }

                // Create bucket link element
                function createBucketLink(bucketName) {
                    const link = createElement("a", "");
                    link.href = "#";
                    link.textContent = bucketName;
                    link.className =
                        "block text-blue-600 dark:text-blue-400 hover:underline p-2 bg-gray-50 dark:bg-gray-700 rounded-md transition-colors";
                    link.addEventListener(
                        "click",
                        handleBucketClick(bucketName),
                    );
                    return link;
                }

                // Fetch and render the list of existing buckets
                async function fetchAndRenderBuckets() {
                    try {
                        const response = await fetch("/api/buckets");

                        if (!response.ok) {
                            throw new Error("Failed to fetch bucket list.");
                        }

                        const bucketNames = await response.json();
                        elements.bucketsList.replaceChildren();

                        if (bucketNames.length === 0) {
                            const noBucketsMsg = createElement(
                                "p",
                                "text-gray-500 dark:text-gray-400",
                                "No existing buckets found.",
                            );
                            elements.bucketsList.appendChild(noBucketsMsg);
                            return;
                        }

                        const fragment = document.createDocumentFragment();
                        bucketNames.forEach((bucketName) => {
                            fragment.appendChild(createBucketLink(bucketName));
                        });
                        elements.bucketsList.appendChild(fragment);
                    } catch (error) {
                        console.error("Error fetching buckets:", error);
                        const errorMsg = createElement(
                            "p",
                            "text-red-500 dark:text-red-400",
                            "Could not load bucket list.",
                        );
                        elements.bucketsList.replaceChildren(errorMsg);
                    }
                }

                // Initialize the application
                function init() {
                    // Cache DOM elements
                    elements.createBucketBtn =
                        document.getElementById("createBucketBtn");
                    elements.bucketNameInput =
                        document.getElementById("bucketName");
                    elements.bucketPasswordInput =
                        document.getElementById("bucketPassword");
                    elements.bucketsList =
                        document.getElementById("bucketsList");
                    elements.errorMessage =
                        document.getElementById("errorMessage");
                    elements.errorText = document.getElementById("errorText");

                    // Set up event listeners
                    elements.createBucketBtn.addEventListener(
                        "click",
                        createBucket,
                    );
                    elements.bucketNameInput.addEventListener(
                        "keypress",
                        handleEnterKey,
                    );
                    elements.bucketPasswordInput.addEventListener(
                        "keypress",
                        handleEnterKey,
                    );

                    // Load existing buckets
                    fetchAndRenderBuckets();
                }

                // Start when DOM is ready
                document.addEventListener("DOMContentLoaded", init);
            })();
        </script>
    </body>
</html>
